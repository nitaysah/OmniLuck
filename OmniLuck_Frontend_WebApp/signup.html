<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sign Up - OmniLuck</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">
    <style>
        .signup-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            z-index: 2;
            position: relative;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--deep-purple);
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--deep-purple) 0%, #4a2c6d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-container {
            width: 100%;
            max-width: 360px;
            background: rgba(255, 255, 255, 0.95);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .input-row {
            margin-bottom: 12px;
            text-align: left;
        }

        .input-row label {
            display: block;
            font-size: 0.85rem;
            color: var(--deep-purple);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .input-row input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(128, 77, 179, 0.2);
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
        }

        .submit-btn {
            background: var(--deep-purple);
            color: white;
            width: 100%;
            border: none;
            padding: 14px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .submit-btn:active {
            transform: scale(0.98);
        }

        .back-link {
            display: block;
            margin-top: 16px;
            color: var(--deep-purple-lighter);
            text-decoration: none;
            font-size: 0.9rem;
        }
    </style>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
</head>

<body>
    <!-- Colliding Galaxy Background (Shared) -->
    <div class="galaxy-container">
        <div class="galaxy-wrapper">
            <div class="galaxy milky-way">
                <div class="galaxy-core"></div>
                <div class="arm"></div>
                <div class="arm"></div>
                <div class="arm"></div>
            </div>
            <div class="galaxy andromeda">
                <div class="galaxy-core"></div>
                <div class="arm"></div>
                <div class="arm"></div>
                <div class="arm"></div>
            </div>
            <div class="stars"></div>
        </div>
    </div>

    <div class="signup-view">
        <h1 class="hero-title">Create Account</h1>

        <div class="form-container">
            <form id="signup-form">
                <div class="input-row">
                    <label>Username</label>
                    <input type="text" id="username" required placeholder="Choose a unique username">
                </div>

                <div class="input-row">
                    <label>First Name</label>
                    <input type="text" id="fname" required>
                </div>

                <div class="input-row">
                    <label>Middle Name (If Any)</label>
                    <input type="text" id="mname">
                </div>

                <div class="input-row">
                    <label>Last Name</label>
                    <input type="text" id="lname" required>
                </div>

                <div class="input-row">
                    <label>Email Address</label>
                    <input type="email" id="email" required>
                </div>

                <div class="input-row">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>

                <div class="input-row">
                    <label>Confirm Password</label>
                    <input type="password" id="confirm-password" required>
                </div>

                <div class="input-row">
                    <label>Date of Birth</label>
                    <input type="date" id="dob" required>
                </div>

                <div class="input-row">
                    <label>Place of Birth</label>
                    <input type="text" id="birth-place" placeholder="City, Country (e.g. Dallas, USA)" required>
                </div>

                <div class="input-row">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <label style="margin-bottom: 0;">Time of Birth</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button id="tob-info-btn" type="button"
                                style="background:none; border:1px solid var(--deep-purple); color:var(--deep-purple); border-radius:50%; width:16px; height:16px; font-size:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0;">i</button>
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                        <input type="checkbox" id="tob-na-checkbox" style="width: auto; margin: 0;">
                        <label for="tob-na-checkbox"
                            style="font-size: 0.8rem; color: var(--deep-purple); margin: 0; cursor: pointer;">Don't
                            know</label>
                    </div>

                    <div id="time-inputs-container">
                        <input type="time" id="birth-time">
                    </div>

                    <div id="tob-na-message"
                        style="display: none; font-size: 0.75rem; color: var(--deep-purple); opacity: 0.8; font-style: italic; margin-top: 4px;">
                        Midday Alignment Active: Following the Astrology standard for unknown birth times, your chart is
                        anchored to 12:00 PM to maximize planetary accuracy and ensure a reliable luck forecast.
                    </div>

                    <div id="tob-explainer"
                        style="display: none; font-size: 0.75rem; color: var(--deep-purple); background: rgba(128,77,179,0.1); padding: 8px; border-radius: 8px; margin-top: 4px; line-height: 1.4;">
                        Add your exact local time of birth for full precision. This data acts as your cosmic GPS,
                        identifying the precise degrees of your Rising Sign and the 12 Life Houses that shift every few
                        minutes. These details are vital for accurate daily insights and a truly personalized Luck
                        Score. If unknown, we apply the 12:00 PM Astrology standard to maximize planetary accuracy and
                        provide reliable guidance.
                    </div>
                </div>

                <button type="submit" class="submit-btn" style="margin-top: 10px;">Sign Up</button>
            </form>

            <a href="index.html" class="back-link">Wait, I have an account</a>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const form = document.getElementById('signup-form');

        // Geocoding Helper
        async function geocodeCity(city) {
            if (!city) return null;
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        name: data[0].display_name
                    };
                }
            } catch (e) {
                console.error("Geocoding failed", e);
            }
            return null;
        }

        // Toggle UI Logic
        const tobInfoBtn = document.getElementById('tob-info-btn');
        const tobExplainer = document.getElementById('tob-explainer');
        if (tobInfoBtn) {
            tobInfoBtn.addEventListener('click', (e) => {
                e.preventDefault();
                tobExplainer.style.display = tobExplainer.style.display === 'none' ? 'block' : 'none';
            });
        }

        const tobNaCheckbox = document.getElementById('tob-na-checkbox');
        const timeContainer = document.getElementById('time-inputs-container');
        const naMessage = document.getElementById('tob-na-message');
        const birthTimeInput = document.getElementById('birth-time');

        if (tobNaCheckbox) {
            tobNaCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    timeContainer.style.display = 'none';
                    naMessage.style.display = 'block';
                    birthTimeInput.value = '';
                    birthTimeInput.required = false;
                } else {
                    timeContainer.style.display = 'block';
                    naMessage.style.display = 'none';
                    birthTimeInput.required = true;
                }
            });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.querySelector('.submit-btn');
            const originalBtnText = submitBtn.textContent;
            submitBtn.textContent = "Creating Account...";
            submitBtn.disabled = true;

            const username = document.getElementById('username').value.trim();
            const fname = document.getElementById('fname').value.trim();
            const mname = document.getElementById('mname').value.trim();
            const lname = document.getElementById('lname').value.trim();
            const email = document.getElementById('email').value.trim().toLowerCase();
            const password = document.getElementById('password').value.trim();
            const confirmPassword = document.getElementById('confirm-password').value.trim();
            const dob = document.getElementById('dob').value;
            const birthPlace = document.getElementById('birth-place').value.trim();

            // Time Logic
            let birthTimeVal = birthTimeInput.value;
            if (tobNaCheckbox.checked) {
                birthTimeVal = "12:00";
            }

            // Simple Validation
            if (!username || !fname || !lname || !email || !password || !confirmPassword || !dob || !birthPlace || !birthTimeVal) {
                alert('Please fill in all required fields.');
                submitBtn.textContent = originalBtnText;
                submitBtn.disabled = false;
                return;
            }

            // Check if passwords match
            if (password !== confirmPassword) {
                alert('Passwords do not match. Please try again.');
                submitBtn.textContent = originalBtnText;
                submitBtn.disabled = false;
                return;
            }

            try {
                // 1. Geocode Birth Place
                const coords = await geocodeCity(birthPlace);

                if (!coords) {
                    alert("Could not find location '" + birthPlace + "'. Please validate the city and country name (e.g. Dallas, USA).");
                    submitBtn.textContent = originalBtnText;
                    submitBtn.disabled = false;
                    return;
                }

                // 2. Check if Username is unique
                const q = query(collection(db, "users"), where("username", "==", username));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    throw new Error("This username is already taken. Please choose another.");
                }

                // 3. Create Auth User
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const fullName = `${fname} ${mname ? mname + ' ' : ''}${lname}`;

                // 4. Update Auth Profile (Display Name)
                await updateProfile(user, {
                    displayName: fullName
                });

                // 5. Save User Data to Firestore
                const userData = {
                    uid: user.uid,
                    username: username,
                    email: email,
                    name: fullName,
                    firstName: fname,
                    middleName: mname,
                    lastName: lname,
                    dob: dob,
                    birth_place: birthPlace,
                    birth_time: birthTimeVal,
                    lat: coords ? coords.lat : 0.0,
                    lon: coords ? coords.lon : 0.0,
                    createdAt: new Date().toISOString()
                };

                await setDoc(doc(db, "users", user.uid), userData);

                // 5. Save to LocalStorage (Session Cache for Speed)
                // We keep this so existing app.html logic works instantly without rewrite
                localStorage.setItem('currentUser', JSON.stringify(userData));

                alert('Account created successfully!');
                window.location.href = 'app.html';

            } catch (error) {
                console.error("Signup Error:", error);

                let msg = error.message;
                if (error.code === 'auth/email-already-in-use') {
                    msg = "This email is already registered. Please Sign In.";
                } else if (error.code === 'auth/weak-password') {
                    msg = "Password should be at least 6 characters.";
                }

                alert(msg);
                submitBtn.textContent = originalBtnText;
                submitBtn.disabled = false;
            }
        });
    </script>
</body>

</html>